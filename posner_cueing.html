<!DOCTYPE html>
<html>

<meta charset="UTF-8">

<head>
    <title>Posner Cueing Paradigm</title>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugins/jspsych-posner-cueing.js"></script>
    <script src="jspsych/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych/plugins/jspsych-instructions.js"></script>
    <script src="jspsych/plugins/jspsych-survey-text.js"></script>
    <link href="jspsych/css/jspsych.css" rel="stylesheet" type="text/css">
    </link>
</head>

<body></body>

<script>

    function download(filename, text) {
        // creates downloadable file containing text arg with name filename on client-side and prompts download
        var fileDL = document.createElement('a');
        fileDL.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        fileDL.setAttribute('download', filename);
        fileDL.style.display = 'none';
        document.body.appendChild(fileDL);
        fileDL.click();
        document.body.removeChild(fileDL);
    }

    var saveData = function() {
        // get subject initials
        var initials = JSON.parse(jsPsych.data.get().filter({trial_type: 'survey-text'}).values()[0].responses).Q0;
        // append UNIX timestamp (to reduce probability of filename collisions)
        var timestamp = Date.now();
        download(initials+timestamp+".csv", jsPsych.data.get().filter({trial_type: 'posner-cueing'}).csv());
    }

    var timeline = [];

    var fix_cross = {
        type: 'html-keyboard-response',
        stimulus: '<div style="font-size:60px;color:#ffffff">+</div>',
        choices: jsPsych.NO_KEYS,
        trial_duration: 1000
    };

    var trial_conditions = [];

    var trial = {
        type: "posner-cueing",
        cue_duration: 50,
        cue_off_target_on_interval: 1500
    };

    for (cond_cong in [0, 1, 2]) {  // valid/invalid/neutral
            for (targ in [0, 1]) {  // target left/right
                for (cond_cue in [0, 1]) {  // arrow/face
                    t = Object.assign({}, trial, { condition_congruency: cond_cong, condition_cuetype: cond_cue, target_loc: targ });
                    trial_conditions.push(t);
                    //timeline.push(t);
                }
            }
        }

    timeline.push(
        initials = {
            type: 'survey-text',
            questions: [{prompt: "Before you begin, please enter your initials"}]
        }
    );

    timeline.push(
        instructions = {
            type: 'instructions',
            pages: [
                "Welcome to EXPRA 2019! Press the right arrow key [â†’] key to continue.",
                "This is a placeholder for the instructions.",
                "This is a placeholder for additional info."
            ]
        }
    );
    
    var trials = [];
    trials.push(trial_conditions[2]);
    trials.push(trial_conditions[4]);
    trials.push(trial_conditions[3]);
    trials = trials.map(t => [fix_cross, t]).flat();
    timeline = timeline.concat(trials);

    jsPsych.init({
        timeline: timeline,
        show_progress_bar: true,
        on_trial_finish: function () {
            setTimeout(jsPsych.resumeExperiment, 200);
        },
        on_finish: function() { saveData(); }
    });

</script>

</html>