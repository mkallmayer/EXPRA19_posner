<!DOCTYPE html>
<html>

<meta charset="UTF-8">

<head>
    <title>Posner Cueing Paradigm</title>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugins/jspsych-posner-cueing.js"></script>
    <script src="jspsych/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych/plugins/jspsych-instructions.js"></script>
    <script src="jspsych/plugins/jspsych-survey-text.js"></script>
    <link href="jspsych/css/jspsych.css" rel="stylesheet" type="text/css">
    </link>
</head>

<body></body>

<script>
    var downloadData = function() {
        // get subject initials
        var initials = JSON.parse(jsPsych.data.get().filter({trial_type: 'survey-text'}).values()[0].responses).Q0;
        // append UNIX timestamp (to reduce probability of name collisions)
        var timestamp = Date.now();
        var filename = initials+timestamp+".csv";
        var text = jsPsych.data.get().filter({trial_type: 'posner-cueing'}).csv();

        // creates downloadable file containing text arg with name filename on client-side and prompts download
        var fileDL = document.createElement('a');
        fileDL.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        fileDL.setAttribute('download', filename);
        fileDL.style.display = 'none';
        document.body.appendChild(fileDL);
        fileDL.click();
        document.body.removeChild(fileDL);
    }

    // preload all images used in the experiment
    jsPsych.pluginAPI.preloadImages(["target"].concat(["cue_left_", "cue_right_", "cue_neut_"].map(v => [v+"face", v+"arr"]).flat()).map(u => "jspsych/"+u+".png"), 
                                    function(){ console.log("image preloading successful"); },
                                    function(){ console.log("preloading images") })
    var psyRand = jsPsych.randomization;
    var timeline = [];
    var trial_conds = [[[],[],[]],[[],[],[]]];  // nested structure storing trial types
    var trial_number = 1;

    var fix_cross = {
        type: 'html-keyboard-response',
        stimulus: '<div style="font-size:60px;color:#ffffff">+</div>',
        choices: jsPsych.NO_KEYS,
        trial_duration: 1000
    };

    var trial = {
        type: "posner-cueing"
    };

    for (cuetype in [0, 1]) {  // arrow/face cue
        for (congruency in [0, 1, 2]) {  // valid/invalid/neutral
            for (targetpos in [0, 1]) {  // left/right target
                var t = new Object({type: "posner-cueing", condition_congruency: congruency, condition_cuetype: cuetype, target_loc: targetpos });
                trial_conds[cuetype][congruency][targetpos] = t;  // new trial type is stored in 3D array
            }
        }
    }

    timeline.push(
        initials = {
            type: 'survey-text',
            questions: [{prompt: "Before you begin, please enter your initials"}]
        }
    );

    timeline.push(
        instructions = {
            type: 'instructions',
            pages: [
                "Welcome to EXPRA 2019! Press the right arrow key (<b>[→]</b>) key to continue.",
                "<h1>Background (1/3)</h1>" + 
                "A \"spotlight\" is a metaphor that nicely captures many characteristics of " +
                "the focus of visual attention: It is a \"beam\" that is moved spatially, that may not " +
                "be divided, and that enhances the detection of events falling within it." +
                "<br> <b>[→]</b>",
                "<h1>Background (2/3)</h1>" + 
                "Some of the strongest evidence supporting the unitary concept of attention comes from the " +
                "luminance-detection paradigm (e.g., Posner, 1980). In such experiments, subjects are first cued " +
                "with the likely spatial location of a target and then respond as rapidly as possible when the target " +
                "appears at any location in the display. For example, in a typical display, the stimuli are arranged " +
                "horizontally with a fixation point in the center, which is also the location where the cue appears. The " +
                "cue is either valid, correctly identifying the spatial location of the target, or invalid, incorrectly " +
                "identifying the location of the target. Following the presentation of the cue, a single target stimulus " +
                "is illuminated (usually about 1000 ms after the onset of the cue) and subjects respond as soon as they detect " +
                "the target, regardless of its location. Relative to a neutral cue condition, responses are faster when the " +
                "target appears in the cued location (a valid trial) and slower when the target appears in a non-cued location (an invalid trial). " +
                "<br> <b>[→]</b>",
                "<h1>Background (3/3)</h1>" + 
                "Demonstrations of these patterns of results occur independently of eye movements. In other words, when an eye tracker verifies " +
                "that your eyes are still fixed on the center, your focus of attention can be off to the right, or off to the left. While other " +
                "interpretations of these findings are possible, they are consistent with the notion of a focused beam of attention that may be moved " +
                "to distinct spatial locations - incorrectly in the case of an invalid trial and correctly in the case of a valid trial. " +
                "<br> <b>[→]</b>",
                "<h1>Instructions (1/2)</h1>" + 
                "Start a trial by pressing the <b>[space]</b> bar. A fixation cross will appear in the middle of the window. Stare at it. A short time later, a " +
                "cue will appear. Cues can EITHER be arrows pointing left, right or in both directions OR images of a face gazing left, right or straight ahead. " +
                "<br>If the cue is pointing to the right, 80% of the time the target will appear on the right.<br>If the cue is pointing to the left, " +
                "80% of the time, the target will appear on the left.<br>If the cue is pointing neither to the left, nor to the right exclusively, " +
                "the target is equally likely to appear on the left or right. " +
                "A short time after the cue disappears, a green circle will appear." +
                "<br> <b>[→]</b>",
                "<h1>Instructions (2/2)</h1>" + 
                "Your task is to respond as quickly as possible when you see the circle appear, regardless of its location. To respond, press the <b>[n]</b> key. " +
                "After pressing the <b>[n]</b> key, press the <b>[space]</b> bar to start the next trial. There are 200 trials." +
                "<br> <b>[→]</b>",
                "You can start the experiment by pressing the <b>[→]</b> key once more.<br>" +
                "Remember: start a trial by pressing the <b>[space]</b> key and, once the trial has started, press the <b>[n]</b> as quickly as possible when you see the <b>green circle</b>" 
            ]
        }
    );

    timeline.push(
        empty = {
            type: 'html-keyboard-response',
            stimulus: '',
            choices: [32]
        }
    );

    var arrow_trials = 
        [].concat(Array(5).fill(trial_conds[0][2][0]), Array(5).fill(trial_conds[0][2][1]),
                  Array(4).fill(trial_conds[0][0][0]), Array(4).fill(trial_conds[0][0][1]),
                  Array(1).fill(trial_conds[0][1][0]), Array(1).fill(trial_conds[0][1][1]));
    var face_trials =
        [].concat(Array(5).fill(trial_conds[1][2][0]), Array(5).fill(trial_conds[1][2][1]),
                  Array(4).fill(trial_conds[1][0][0]), Array(4).fill(trial_conds[1][0][1]),
                  Array(1).fill(trial_conds[1][1][0]), Array(1).fill(trial_conds[1][1][1]));
    arrow_trials = psyRand.repeat(arrow_trials, 6);
    face_trials = psyRand.repeat(face_trials, 4);
    
    var trials = psyRand.shuffle([].concat(arrow_trials, face_trials));  // shuffle the trials
    N_trials = trials.length;
    trials = trials.map(t => [fix_cross, t]).flat();  // display fixation cross before each trial begins
    timeline = timeline.concat(trials);

    jsPsych.init({
        timeline: timeline,
        on_trial_finish: function () {
            setTimeout(jsPsych.resumeExperiment, 200);
        },
        on_finish: function() { downloadData(); }
    })
</script>

</html>